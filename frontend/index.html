<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Online Attendance System </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #004aad;
      --primary-dark: #003580;
      --accent: #00bfa6;
      --bg-light: #f4f8ff;
      --text-dark: #1e293b;
      --text-gray: #475569;
      --card-bg: #ffffff;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #e7efff 0%, #f8fbff 100%);
      padding: 2rem;
      color: var(--text-dark);
      min-height: 100vh;
    }
    .container {
      background: var(--card-bg);
      border-radius: 1.25rem;
      padding: 2rem;
      max-width: 1150px;
      margin: auto;
      box-shadow: 0 8px 35px rgba(0, 74, 173, 0.15);
      border: 1px solid #e0ecff;
    }
    .college-header {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    .college-header img {
      height: 80px;
      width: 80px;
      border-radius: 12px;
      border: 2px solid var(--primary);
      background: #fff;
      object-fit: contain;
      padding: 4px;
    }
    .college-title h2 {
      font-size: 1.15rem;
      font-weight: 800;
      color: var(--primary-dark);
      line-height: 1.2;
    }
    .college-title p {
      margin: 0;
      color: var(--text-gray);
      font-size: 0.88rem;
    }
    .section-title {
      text-align: center;
      color: var(--primary-dark);
      font-size: 2rem;
      font-weight: 800;
      margin: 1rem 0 1.5rem;
    }
    .card {
      background: #ffffff;
      border-radius: 1rem;
      border: 1px solid #e4ecf8;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 16px rgba(0, 74, 173, 0.05);
      transition: transform 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
    }
    .btn {
      display: inline-block;
      padding: 0.85rem 1.2rem;
      border-radius: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      color: white;
      background: var(--primary);
      border: none;
      transition: all 0.25s ease-in-out;
    }
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 5px 15px rgba(0, 74, 173, 0.3);
    }
    .btn.secondary {
      background: #e3edff;
      color: var(--primary-dark);
      border: 1px solid #bcd0ff;
    }
    .btn.secondary:hover {
      background: var(--primary);
      color: white;
    }
    .input, select, input[type=text], input[type=email], input[type=password], input[type=date] {
      width: 100%;
      padding: 0.9rem 1rem;
      border-radius: 0.75rem;
      border: 1px solid #d2dff7;
      background: #f8fbff;
      transition: 0.2s;
    }
    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 74, 173, 0.15);
      outline: none;
      background: white;
    }
    .message-box {
      border-radius: 0.75rem;
      text-align: center;
      padding: 0.85rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .msg-success { background: #e6f8f2; color: #046c4e; border: 1px solid #32d399; }
    .msg-error { background: #ffecec; color: #b91c1c; border: 1px solid #fca5a5; }
    .attendance-table th {
      background: var(--primary);
      color: white;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .attendance-table td, .attendance-table th {
      border: 1px solid #e3ebfa;
      padding: 10px 12px;
      text-align: center;
    }
    .attendance-table tr:nth-child(even) { background: #f9fbff; }
    .present { color: #059669; font-weight: 700; }
    .absent { color: #dc2626; font-weight: 700; }
    .section-subtitle {
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .hidden { display: none; }
    .small { font-size: 0.85rem; color: var(--text-gray); }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="college-header">
      <img src="gvplogo.png" alt="GVP Logo" onerror="this.style.display='none'">
      <div class="college-title">
        <h2>GAYATRI VIDYA PARISHAD COLLEGE FOR DEGREE AND PG COURSES (AUTONOMOUS)</h2>
        <p>(Affiliated to Andhra University | Accredited by NAAC with 'A' Grade)</p>
        <p>(MBA and UG Engineering B.Tech(CE, CSE, ECE and ME) programs are Accredited by NBA)</p>
        <p>Visakhapatnam - 530045</p>
      </div>
    </div>

    <h1 class="section-title">Online Attendance System</h1>

    <!-- Message -->
    <div id="message-box" class="hidden message-box"></div>

    <!-- Unified Login Card -->
    <div id="login-card" class="card">
      <h3 style="font-size:1.25rem;font-weight:800;margin-bottom:12px;text-align:center">Sign in</h3>

      <div style="max-width:720px;margin:0 auto">
        <div style="display:grid;gap:12px">
          <div>
            <label class="small">Role</label>
            <select id="role-select" class="input">
              <option value="">Select role</option>
              <option value="lecturer">Lecturer</option>
              <option value="student">Student</option>
            </select>
          </div>

          <!-- Lecturer fields -->
          <div id="lecturer-fields" class="hidden">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px">
              <div><label class="small">Email</label><input id="lecturer-email" type="email" class="input" placeholder="lecturer@college.edu" /></div>
              <div><label class="small">Password</label><input id="lecturer-password" type="password" class="input" placeholder="password" /></div>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="login-lecturer-btn" class="btn">Sign in as Lecturer</button>
            </div>
          </div>

          <!-- Student fields -->
          <div id="student-fields" class="hidden">
            <div style="display:flex;gap:8px;max-width:520px">
              <input id="student-id-input" class="input" placeholder="Enter your Student ID or Roll" />
              <button id="login-student-btn" class="btn">Sign in as Student</button>
            </div>
            <p class="small">Student sign-in is a quick local lookup (requires backend students list).</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Lecturer Portal -->
    <div id="lecturer-portal" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h3 style="font-size:1.25rem;font-weight:800;color:#0f172a">Lecturer Portal</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="small" id="lecturer-userinfo">User: â€”</span>
          <button id="logout-btn" class="btn secondary">Logout</button>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef3fb"/>

      <!-- Upload CSV -->
      <div style="margin-bottom:12px" class="card">
        <h4 style="font-weight:800;margin-bottom:8px">Upload Students CSV</h4>
        <p class="small">CSV must include headers: <code>studentId,rollNumber,name,branch,section,academicYear</code></p>
        <input type="file" id="csv-upload" accept=".csv" multiple/>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="upload-csv-btn" class="btn">Upload CSV(s)</button>
          <button id="refresh-students-btn" class="btn secondary">Refresh Student List</button>
        </div>
      </div>

      <!-- Add Student -->
      <div style="margin-bottom:12px" class="card">
        <h4 style="font-weight:800;margin-bottom:8px">Add Student</h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
          <div><label class="small">Student ID</label><input id="add-studentId" class="input" /></div>
          <div><label class="small">Roll Number</label><input id="add-roll" class="input" /></div>
          <div><label class="small">Name</label><input id="add-name" class="input" /></div>
          <div><label class="small">Branch</label><input id="add-branch" class="input" /></div>
          <div><label class="small">Section</label><input id="add-section" class="input" /></div>
          <div><label class="small">Academic Year</label><input id="add-year" class="input" /></div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="add-student-btn" class="btn">Add Student</button>
        </div>
      </div>

      <!-- Manage Students Table -->
      <div style="margin-bottom:12px" class="card">
        <h4 style="font-weight:800;margin-bottom:8px">Manage Students</h4>
        <div style="overflow-x:auto;max-height:280px">
          <table class="attendance-table" id="students-table" style="width:100%">
            <thead><tr><th>Action</th><th>Roll</th><th>Student ID</th><th>Name</th><th>Branch</th><th>Section</th><th>Year</th></tr></thead>
            <tbody id="students-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Mark Attendance -->
      <div style="margin-bottom:12px" class="card">
        <h4 style="font-weight:800;margin-bottom:8px">Mark Attendance</h4>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-bottom:8px">
          <div><label class="small">Branch</label><select id="filter-branch-mark" class="input"><option value="">Select</option><option value="CSE">CSE</option><option value="ECE">ECE</option><option value="MECH">MECH</option><option value="CIVIL">CIVIL</option><option value="EEE">EEE</option></select></div>
          <div><label class="small">Section</label><select id="filter-section-mark" class="input"><option value="">Select</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
          <div><label class="small">Academic Year</label><select id="filter-year-mark" class="input"><option value="">Select</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
          <div><label class="small">Class Name</label><input id="class-name" class="input" placeholder="Enter class name" /></div>
          <div><label class="small">Date</label><input id="attendance-date" type="date" class="input" /></div>
        </div>

        <div style="overflow-x:auto" id="attendance-list-container">
          <table class="attendance-table" id="attendance-mark-table" style="width:100%">
            <thead><tr><th>Roll</th><th>Name</th><th>Attendance</th></tr></thead>
            <tbody id="attendance-list-body"></tbody>
          </table>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="save-attendance-btn" class="btn">Save Attendance</button>
        </div>
      </div>

      <!-- Historical Attendance -->
      <div style="margin-bottom:12px" class="card">
        <h4 style="font-weight:800;margin-bottom:8px">View Historical Attendance</h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:8px">
          <div><label class="small">Branch</label><select id="filter-branch-history" class="input"><option value="">Select</option><option value="CSE">CSE</option><option value="ECE">ECE</option><option value="MECH">MECH</option><option value="CIVIL">CIVIL</option><option value="EEE">EEE</option></select></div>
          <div><label class="small">Section</label><select id="filter-section-history" class="input"><option value="">Select</option><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
          <div><label class="small">Academic Year</label><select id="filter-year-history" class="input"><option value="">Select</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
          <div style="grid-column:span 2"><label class="small">Class Name</label><input id="class-name-history" class="input" placeholder="Enter class name"/></div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="view-history-btn" class="btn">View History</button>
        </div>
        <div id="history-display" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Student Portal -->
    <div id="student-portal" class="card hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h3 style="font-size:1.25rem;font-weight:800;color:#064e3b">Student Portal</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="small" id="student-userinfo">Student: â€”</span>
          <button id="student-logout-btn" class="btn secondary">Logout</button>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef3fb"/>

      <div id="student-input-area">
        <div style="display:flex;gap:10px;max-width:600px;margin:0 auto">
          <input id="student-portal-id" class="input" placeholder="Enter your Student ID"/>
          <button id="student-view-btn" class="btn">View My Attendance</button>
        </div>
        <p class="small" style="text-align:center;margin-top:8px">If you logged in as student, your ID will be prefilled.</p>
      </div>

      <div id="student-details" class="hidden" style="margin-top:12px">
        <h4 style="font-weight:800">Your Details</h4>
        <table class="attendance-table" style="width:100%;margin-bottom:12px">
          <tbody id="student-details-body"></tbody>
        </table>

        <h4 style="font-weight:800">Attendance Summary</h4>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div><strong class="small">Overall %:</strong> <span id="student-att-perc">0%</span></div>
        </div>

        <h4 style="font-weight:800;margin-top:12px">Attendance Records</h4>
        <div id="student-att-list" style="margin-top:8px"></div>
      </div>
    </div>

  </div>

  <!-- Firebase + App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase config (user requested to include) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCZw-psITQ1bgw1nl7HnG56Q9F-c6nH-F8",
      authDomain: "attendance-3f978.firebaseapp.com",
      projectId: "attendance-3f978",
      storageBucket: "attendance-3f978.firebasestorage.app",
      messagingSenderId: "385341970643",
      appId: "1:385341970643:web:e8aaa51b8b22f93588dc26",
      measurementId: "G-HD45MB18DJ"
    };

    // Backend
    const BACKEND_URL = 'http://127.0.0.1:5000';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = firebaseConfig.projectId || 'attendance-3f978';

    // --- UI refs ---
    const roleSelect = document.getElementById('role-select');
    const lecturerFields = document.getElementById('lecturer-fields');
    const studentFields = document.getElementById('student-fields');

    const loginLectBtn = document.getElementById('login-lecturer-btn');
    const loginStudentBtn = document.getElementById('login-student-btn');

    const messageBox = document.getElementById('message-box');

    const lecturerPortal = document.getElementById('lecturer-portal');
    const studentPortal = document.getElementById('student-portal');
    const loginCard = document.getElementById('login-card');

    const lecturerUserinfo = document.getElementById('lecturer-userinfo');
    const studentUserinfo = document.getElementById('student-userinfo');

    const logoutBtn = document.getElementById('logout-btn');
    const studentLogoutBtn = document.getElementById('student-logout-btn');

    // Lecturer elements
    const csvUploadInput = document.getElementById('csv-upload');
    const uploadCsvBtn = document.getElementById('upload-csv-btn');
    const refreshStudentsBtn = document.getElementById('refresh-students-btn');
    const studentsTbody = document.getElementById('students-tbody');

    const addStudentIdInput = document.getElementById('add-studentId');
    const addRollInput = document.getElementById('add-roll');
    const addNameInput = document.getElementById('add-name');
    const addBranchInput = document.getElementById('add-branch');
    const addSectionInput = document.getElementById('add-section');
    const addYearInput = document.getElementById('add-year');
    const addStudentBtn = document.getElementById('add-student-btn');

    const filterBranchMark = document.getElementById('filter-branch-mark');
    const filterSectionMark = document.getElementById('filter-section-mark');
    const filterYearMark = document.getElementById('filter-year-mark');
    const classNameInput = document.getElementById('class-name');
    const attendanceDateInput = document.getElementById('attendance-date');
    const attendanceListBody = document.getElementById('attendance-list-body');
    const saveAttendanceBtn = document.getElementById('save-attendance-btn');

    const filterBranchHistory = document.getElementById('filter-branch-history');
    const filterSectionHistory = document.getElementById('filter-section-history');
    const filterYearHistory = document.getElementById('filter-year-history');
    const classNameHistory = document.getElementById('class-name-history');
    const viewHistoryBtn = document.getElementById('view-history-btn');
    const historyDisplay = document.getElementById('history-display');

    // Student elements
    const studentPortalId = document.getElementById('student-portal-id');
    const studentViewBtn = document.getElementById('student-view-btn');
    const studentDetailsSection = document.getElementById('student-details');
    const studentDetailsBody = document.getElementById('student-details-body');
    const studentAttPerc = document.getElementById('student-att-perc');
    const studentAttList = document.getElementById('student-att-list');

    // state
    let allStudents = [];
    let currentUserRole = null;
    let sessionUserId = null; // firebase uid or 'student:<id>'

    // Helper - show message
    function showMessage(msg, type = 'success') {
      messageBox.textContent = msg;
      messageBox.className = `message-box ${type === 'success' ? 'msg-success' : 'msg-error'}`;
      messageBox.classList.remove('hidden');
      setTimeout(()=> { messageBox.classList.add('hidden'); }, 5000);
    }

    roleSelect.addEventListener('change', () => {
      const r = roleSelect.value;
      if (r === 'lecturer') { lecturerFields.classList.remove('hidden'); studentFields.classList.add('hidden'); }
      else if (r === 'student') { studentFields.classList.remove('hidden'); lecturerFields.classList.add('hidden'); }
      else { lecturerFields.classList.add('hidden'); studentFields.classList.add('hidden'); }
    });

    // Initialize date input to today
    (function setToday() {
      const t = new Date();
      const yyyy = t.getFullYear();
      const mm = String(t.getMonth()+1).padStart(2,'0');
      const dd = String(t.getDate()).padStart(2,'0');
      attendanceDateInput.value = `${yyyy}-${mm}-${dd}`;
    })();

    // Fetch all students from backend
    async function fetchAllStudents() {
      try {
        const resp = await fetch(`${BACKEND_URL}/api/students`);
        if (!resp.ok) throw new Error('Failed to fetch students from backend');
        const data = await resp.json();
        allStudents = data || [];
        populateStudentsTable();
        return allStudents;
      } catch (err) {
        console.error("fetchAllStudents error:", err);
        showMessage('Error loading students from backend. Is the Flask server running?', 'error');
        allStudents = [];
        populateStudentsTable();
      }
    }

    function populateStudentsTable() {
      studentsTbody.innerHTML = '';
      if (!allStudents || allStudents.length === 0) {
        studentsTbody.innerHTML = '<tr><td colspan="7" class="small">No students found.</td></tr>';
        return;
      }
      const sorted = [...allStudents].sort((a,b) => (a.rollNumber||'').localeCompare(b.rollNumber||''));
      for (const s of sorted) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><button class="btn secondary delete-student-btn" data-id="${escapeHtml(s.studentId || '')}">Delete</button></td>
          <td>${escapeHtml(s.rollNumber || '')}</td>
          <td>${escapeHtml(s.studentId || '')}</td>
          <td>${escapeHtml(s.name || '')}</td>
          <td>${escapeHtml(s.branch || '')}</td>
          <td>${escapeHtml(s.section || '')}</td>
          <td>${escapeHtml(s.academicYear || '')}</td>
        `;
        studentsTbody.appendChild(tr);
      }
      // attach delete handlers
      document.querySelectorAll('.delete-student-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = btn.getAttribute('data-id');
          if (!id) return;
          if (!confirm('Delete student ' + id + '?')) return;
          try {
            const resp = await fetch(`${BACKEND_URL}/api/students/${encodeURIComponent(id)}`, { method: 'DELETE' });
            const text = await resp.text();
            if (!resp.ok) {
              let msg = text;
              try { msg = JSON.parse(text).message || text; } catch(e){}
              showMessage(msg || 'Delete failed', 'error');
              return;
            }
            showMessage('Student deleted');
            await fetchAllStudents();
          } catch (err) {
            console.error("Delete student error:", err);
            showMessage('Error deleting student', 'error');
          }
        });
      });
    }

    // escape helper for safe text insertion
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      return String(str).replace(/[&<>"'`=\/]/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;","/":"&#47;"})[s]; });
    }

    // Lecturer login
    loginLectBtn.addEventListener('click', async () => {
      const email = document.getElementById('lecturer-email').value.trim();
      const password = document.getElementById('lecturer-password').value.trim();
      if (!email || !password) { showMessage('Enter email & password', 'error'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        currentUserRole = 'lecturer';
        showMessage('Logged in as lecturer');
      } catch (err) {
        console.error("Lecturer login error:", err);
        showMessage('Lecturer login failed. Check credentials.', 'error');
      }
    });

    // Student login (quick)
    loginStudentBtn.addEventListener('click', async () => {
      const sid = document.getElementById('student-id-input').value.trim();
      if (!sid) { showMessage('Enter Student ID', 'error'); return; }
      try {
        // Ensure students loaded
        await fetchAllStudents();
        const found = allStudents.find(s => (s.studentId === sid || s.rollNumber === sid));
        if (!found) { showMessage('Student not found', 'error'); return; }

        // anonymous auth to satisfy Firestore reads
        await signInAnonymously(auth);
        currentUserRole = 'student';
        sessionUserId = `student:${found.studentId}`;
        studentPortalId.value = found.studentId;
        showMessage(`Logged in as ${found.name || found.studentId}`);
        renderUI();
      } catch (err) {
        console.error("Student login error:", err);
        showMessage('Student login failed', 'error');
      }
    });

    // Logout handlers
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (e) { console.warn("signOut error:", e); }
      currentUserRole = null;
      sessionUserId = null;
      renderUI();
      showMessage('Logged out');
    });
    studentLogoutBtn.addEventListener('click', async () => {
      try { await signOut(auth); } catch (e){ }
      currentUserRole = null;
      sessionUserId = null;
      renderUI();
      showMessage('Logged out');
    });

    // onAuthStateChanged to set session uid for lecturers
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // If user is anonymous and we already set a student session, keep it
        if (user.isAnonymous && currentUserRole === 'student' && sessionUserId && sessionUserId.startsWith('student:')) {
          // keep student sessionUserId
        } else {
          // treat as lecturer login
          sessionUserId = user.uid;
          currentUserRole = 'lecturer';
        }
        renderUI();
      } else {
        // no firebase user
        if (!currentUserRole) {
          sessionUserId = null;
        }
        renderUI();
      }
    });

    // Render UI based on currentUserRole
    function renderUI() {
      if (currentUserRole === 'lecturer') {
        loginCard.classList.add('hidden');
        lecturerPortal.classList.remove('hidden');
        studentPortal.classList.add('hidden');
        lecturerUserinfo.textContent = `User: ${sessionUserId || '--'}`;
      } else if (currentUserRole === 'student') {
        loginCard.classList.add('hidden');
        lecturerPortal.classList.add('hidden');
        studentPortal.classList.remove('hidden');
        studentUserinfo.textContent = `Student: ${sessionUserId ? sessionUserId.replace('student:','') : '--'}`;
        // prefill id in student portal input if available
        if (sessionUserId && sessionUserId.startsWith('student:')) { studentPortalId.value = sessionUserId.replace('student:',''); }
      } else {
        loginCard.classList.remove('hidden');
        lecturerPortal.classList.add('hidden');
        studentPortal.classList.add('hidden');
      }
    }

    // CSV upload to backend
    uploadCsvBtn.addEventListener('click', async () => {
      if (currentUserRole !== 'lecturer') { showMessage('You must be a lecturer to upload CSVs', 'error'); return; }
      const files = csvUploadInput.files;
      if (!files || files.length === 0) { showMessage('Select CSV file(s) to upload', 'error'); return; }
      const fd = new FormData();
      for (let i=0;i<files.length;i++) fd.append('files', files[i]);
      try {
        const resp = await fetch(`${BACKEND_URL}/api/students/upload`, { method:'POST', body:fd });
        const text = await resp.text();
        if (!resp.ok) {
          let msg = text;
          try { msg = JSON.parse(text).message || text; } catch(e){}
          showMessage(msg || 'CSV upload failed', 'error');
          return;
        }
        const result = JSON.parse(text);
        showMessage(result.message || 'CSV uploaded');
        csvUploadInput.value = '';
        await fetchAllStudents();
      } catch (err) {
        console.error("CSV upload error:", err);
        showMessage('CSV upload failed', 'error');
      }
    });

    // Add student
    addStudentBtn.addEventListener('click', async () => {
      if (currentUserRole !== 'lecturer') { showMessage('Lecturer only', 'error'); return; }
      const payload = {
        studentId: (addStudentIdInput.value || '').trim(),
        rollNumber: (addRollInput.value || '').trim(),
        name: (addNameInput.value || '').trim(),
        branch: (addBranchInput.value || '').trim(),
        section: (addSectionInput.value || '').trim(),
        academicYear: (addYearInput.value || '').trim()
      };
      if (!payload.rollNumber || !payload.branch || !payload.section || !payload.academicYear) {
        showMessage('Provide rollNumber, branch, section and academicYear', 'error'); return;
      }
      try {
        const resp = await fetch(`${BACKEND_URL}/api/students`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const text = await resp.text();
        if (!resp.ok) {
          let msg = text;
          try { msg = JSON.parse(text).message || text; } catch(e){}
          showMessage(msg || 'Add student failed', 'error');
          return;
        }
        const data = JSON.parse(text);
        showMessage(data.message || 'Student added');
        addStudentIdInput.value=''; addRollInput.value=''; addNameInput.value=''; addBranchInput.value=''; addSectionInput.value=''; addYearInput.value='';
        await fetchAllStudents();
      } catch (err) {
        console.error("Add student error:", err);
        showMessage('Error adding student', 'error');
      }
    });

    refreshStudentsBtn.addEventListener('click', async () => {
      await fetchAllStudents();
      showMessage('Student list refreshed');
    });

    // Load students for marking attendance based on filters
    function loadStudentsForMarking() {
      const branch = filterBranchMark.value;
      const section = filterSectionMark.value;
      const year = filterYearMark.value;

      attendanceListBody.innerHTML = '';
      if (!branch || !section || !year) {
        attendanceListBody.innerHTML = '<tr><td colspan="3" class="small">Select Branch, Section and Year to load students.</td></tr>';
        return;
      }
      const filtered = allStudents.filter(s => s.branch === branch && s.section === section && String(s.academicYear) === String(year));
      if (!filtered || filtered.length === 0) {
        attendanceListBody.innerHTML = '<tr><td colspan="3" class="small">No students found for selected filters.</td></tr>';
        return;
      }
      filtered.sort((a,b)=> (a.rollNumber||'').localeCompare(b.rollNumber||''));
      for (const s of filtered) {
        const tr = document.createElement('tr');
        const sid = s.studentId || s.rollNumber || Math.random().toString(36).slice(2,8);
        tr.innerHTML = `
          <td>${escapeHtml(s.rollNumber || '')}</td>
          <td style="text-align:left">${escapeHtml(s.name || '')}</td>
          <td>
            <label style="margin-right:8px"><input type="radio" name="attendance-${escapeHtml(sid)}" value="present"> Present</label>
            <label><input type="radio" name="attendance-${escapeHtml(sid)}" value="absent"> Absent</label>
            <input type="hidden" data-studentid="${escapeHtml(sid)}" />
          </td>
        `;
        attendanceListBody.appendChild(tr);
      }
    }

    filterBranchMark.addEventListener('change', loadStudentsForMarking);
    filterSectionMark.addEventListener('change', loadStudentsForMarking);
    filterYearMark.addEventListener('change', loadStudentsForMarking);

    // Save attendance to Firestore
    saveAttendanceBtn.addEventListener('click', async () => {
      if (currentUserRole !== 'lecturer') { showMessage('Lecturer only', 'error'); return; }
      const className = classNameInput.value.trim();
      const date = attendanceDateInput.value;
      const branch = filterBranchMark.value;
      const section = filterSectionMark.value;
      const year = filterYearMark.value;

      if (!className || !date || !branch || !section || !year) { showMessage('Fill class name, date and filters', 'error'); return; }

      // gather marked
      const rows = attendanceListBody.querySelectorAll('tr');
      const records = {};
      let total = 0;
      for (const r of rows) {
        const radios = r.querySelectorAll('input[type="radio"]');
        if (!radios || radios.length === 0) continue;
        // name is like attendance-<studentId>
        const name = radios[0].name;
        const studentId = name.replace(/^attendance-/, '');
        total++;
        const present = r.querySelector(`input[name="${name}"][value="present"]`);
        const absent = r.querySelector(`input[name="${name}"][value="absent"]`);
        if (present && present.checked) records[studentId] = true;
        else if (absent && absent.checked) records[studentId] = false;
        else {
          showMessage('Mark attendance for all students before saving', 'error');
          return;
        }
      }

      // doc id safe
      const docId = `${className.replace(/\s+/g,'-')}-${branch}-${section}-${year}-${date}`;
      try {
        const attendanceRef = doc(db, `artifacts/${appId}/public/data/attendance`, docId);
        await setDoc(attendanceRef, {
          records,
          lecturerId: sessionUserId || null,
          timestamp: new Date(),
          className,
          branch,
          section,
          academicYear: year,
          date
        });
        showMessage('Attendance saved successfully');
      } catch (err) {
        console.error("Save attendance error:", err);
        showMessage('Error saving attendance (check Firestore rules)', 'error');
      }
    });

    // View historical attendance
    viewHistoryBtn.addEventListener('click', async () => {
      try {
        const branch = filterBranchHistory.value;
        const section = filterSectionHistory.value;
        const year = filterYearHistory.value;
        const cls = classNameHistory.value.trim();
        if (!branch || !section || !year || !cls) { showMessage('Select branch, section, year and enter class name', 'error'); return; }

        const attRef = collection(db, `artifacts/${appId}/public/data/attendance`);
        const q = query(attRef, where("branch","==",branch), where("section","==",section), where("academicYear","==",year), where("className","==",cls));
        const snap = await getDocs(q);
        if (snap.empty) { historyDisplay.innerHTML = `<p class="small">No attendance records found for the selected filters.</p>`; return; }
        // aggregate
        const datesSet = new Set();
        const recordsByStudent = {};
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const date = d.date || (d.timestamp && d.timestamp.toDate ? d.timestamp.toDate().toISOString().slice(0,10) : null);
          if (!date) return;
          datesSet.add(date);
          const recs = d.records || {};
          for (const sid in recs) {
            recordsByStudent[sid] = recordsByStudent[sid] || {};
            recordsByStudent[sid][date] = !!recs[sid];
          }
        });
        const dates = Array.from(datesSet).sort();
        // filter students who belong to branch/section/year and have records
        const students = allStudents.filter(s => s.branch===branch && s.section===section && String(s.academicYear)===String(year) && recordsByStudent[s.studentId]);
        students.sort((a,b)=> (a.rollNumber||'').localeCompare(b.rollNumber||''));
        if (students.length===0) { historyDisplay.innerHTML = `<p class="small">No student records found.</p>`; return; }

        // build table
        let html = `<div style="overflow:auto"><table class="attendance-table"><thead><tr><th>Roll</th><th>Name</th>`;
        for (const d of dates) html += `<th>${escapeHtml(d)}</th>`;
        html += `</tr></thead><tbody>`;
        for (const s of students) {
          html += `<tr><td>${escapeHtml(s.rollNumber || '')}</td><td style="text-align:left">${escapeHtml(s.name || '')}</td>`;
          for (const d of dates) {
            const val = recordsByStudent[s.studentId] && recordsByStudent[s.studentId][d];
            if (val === true) html += `<td class="present">P</td>`;
            else if (val === false) html += `<td class="absent">A</td>`;
            else html += `<td>-</td>`;
          }
          html += `</tr>`;
        }
        html += `</tbody></table></div>`;
        historyDisplay.innerHTML = html;
      } catch (err) {
        console.error("view history error:", err);
        showMessage('Error loading history (check Firestore rules)', 'error');
      }
    });

    // Student view attendance
    studentViewBtn.addEventListener('click', async () => {
      const sid = studentPortalId.value.trim();
      if (!sid) { showMessage('Enter Student ID', 'error'); return; }
      // ensure students loaded
      await fetchAllStudents();
      const student = allStudents.find(s => s.studentId===sid || s.rollNumber===sid);
      if (!student) { showMessage('Student not found', 'error'); return; }
      // populate details
      studentDetailsBody.innerHTML = `
        <tr><th style="text-align:left">Student ID</th><td>${escapeHtml(student.studentId)}</td></tr>
        <tr><th style="text-align:left">Roll Number</th><td>${escapeHtml(student.rollNumber)}</td></tr>
        <tr><th style="text-align:left">Name</th><td>${escapeHtml(student.name)}</td></tr>
        <tr><th style="text-align:left">Branch</th><td>${escapeHtml(student.branch)}</td></tr>
        <tr><th style="text-align:left">Section</th><td>${escapeHtml(student.section)}</td></tr>
        <tr><th style="text-align:left">Academic Year</th><td>${escapeHtml(student.academicYear)}</td></tr>
      `;
      studentDetailsSection.classList.remove('hidden');

      try {
        const attRef = collection(db, `artifacts/${appId}/public/data/attendance`);
        // Get all attendance docs and filter client-side for records containing this student
        const qAll = query(attRef);
        const snap = await getDocs(qAll);
        let total = 0, present = 0;
        const list = [];
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const date = d.date || (d.timestamp && d.timestamp.toDate ? d.timestamp.toDate().toISOString().slice(0,10) : null);
          const recs = d.records || {};
          if (recs[student.studentId] !== undefined) {
            list.push({ date, present: !!recs[student.studentId], className: d.className || '', branch: d.branch || '' });
            total++;
            if (recs[student.studentId]) present++;
          }
        });
        list.sort((a,b)=> new Date(a.date) - new Date(b.date));
        // populate
        if (list.length === 0) {
          studentAttList.innerHTML = `<p class="small">No attendance records found.</p>`;
        } else {
          let out = '<table class="attendance-table" style="width:100%"><thead><tr><th>Date</th><th>Class</th><th>Presence</th></tr></thead><tbody>';
          for (const rec of list) {
            out += `<tr><td>${escapeHtml(rec.date)}</td><td style="text-align:left">${escapeHtml(rec.className)}</td><td>${rec.present ? '<span class="present">Present</span>' : '<span class="absent">Absent</span>'}</td></tr>`;
          }
          out += '</tbody></table>';
          studentAttList.innerHTML = out;
        }
        const perc = total>0 ? ((present/total)*100).toFixed(2) : 0;
        studentAttPerc.textContent = `${perc}%`;
      } catch (err) {
        console.error("student view error:", err);
        showMessage('Error fetching attendance (check Firestore rules)', 'error');
      }
    });

    // Utility: initial load
    (async function init() {
      // show login by default
      renderUI();
      // try to fetch students in background for faster operations
      await fetchAllStudents();
    })();

  </script>
</body>
</html>


